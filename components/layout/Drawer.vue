<template>
  <div
    :class="{ open: drawer }"
    class="drawer-wrapper"
    @click="close">
    <div class="drawer">
      <div
        class="drawer-header"
        @click="close">
        <logo class="header-logo" />
        <span class="close-button">
          <i class="fal fa-times" />
        </span>
      </div>

      <div class="menu">
        <nuxt-link
          v-for="view in views"
          v-show="showViewLink(view.id)"
          :key="view.id"
          :to="`/${view.id}/${regionId}/`"
          class="menu-item"
        >
          {{ view.label }}
          <span class="icon">
            <i class="fal fa-chevron-right" />
          </span>
        </nuxt-link>
      </div>

      <div class="menu">
        <nuxt-link
          v-show="showRegionLink('au')"
          :to="`/${currentView}/au/`"
          class="menu-item">
          All Regions
          <span class="icon">
            <i class="fal fa-chevron-right" />
          </span>
        </nuxt-link>

        <hr
          v-show="showRegionLink('au')"
          class="dropdown-divider">

        <nuxt-link
          v-for="link in links"
          :key="link.id"
          :to="`/${currentView}/${link.id}/`"
          :class="{
            'menu-item-child': link.isChild,
            'menu-item-first-child': link.isFirstChild,
            'menu-item-last-child': link.isLastChild
          }"
          class="menu-item">
          {{ link.label }}
          <span class="icon">
            <i class="fal fa-chevron-right" />
          </span>
        </nuxt-link>
      </div>

      <div class="app-options">
        <div class="control">
          <label>Contribution to</label>
          <consumption-generation-toggle />
        </div>
      </div>

      <app-footer />
    </div>
  </div>
</template>

<script>
import { mapGetters } from 'vuex'

import VIEWS from '~/constants/views.js'
import { getEnergyRegions } from '@/constants/energy-regions.js'
import Logo from '~/components/ui/Logo'
import ConsumptionGenerationToggle from '~/components/ui/ConsumptionGenerationToggle'
import AppFooter from '~/components/layout/AppFooter'

export default {
  components: {
    Logo,
    ConsumptionGenerationToggle,
    AppFooter
  },

  props: {
    open: {
      type: Boolean,
      default: () => false
    }
  },

  data() {
    return {
      drawer: false,
      views: VIEWS,
      regions: getEnergyRegions(),
      links: []
    }
  },

  computed: {
    ...mapGetters({
      currentView: 'currentView',
      showFeatureToggle: 'app/showFeatureToggle',
      featureMetrics: 'feature/metrics',
      featureAuEnergy: 'feature/auEnergy'
    }),
    regionId() {
      return this.$route.params.region
    }
  },

  watch: {
    open(value) {
      this.drawer = value
    },
    currentView(view) {
      this.links = this.getLinks()
    },
    showFeatureToggle(show) {
      if (!show) {
        this.drawer = false
      }
    },
    featureMetrics() {
      if (this.featureMetrics) {
        this.views = VIEWS
      } else {
        this.views = VIEWS.filter(v => v.id !== 'stripes')
      }
    }
  },

  created() {
    this.links = this.getLinks()
  },

  methods: {
    getLinks() {
      // create links without 'all' since a divider is needed
      return this.regions
        .map(r => {
          const isChild = r.parentRegion ? true : false
          const isFirstChild = r.parentFirstChild ? true : false
          const isLastChild = r.parentLastChild ? true : false

          return {
            id: r.id,
            label: r.label,
            isChild,
            isFirstChild,
            isLastChild
          }
        })
        .filter(r => r.id !== 'au')
    },

    close() {
      window.scrollTo(0, 0)
      this.$emit('close')
    },

    showViewLink(view) {
      if (this.featureAuEnergy) {
        return true
      }
      if (this.regionId === 'au' && view === 'energy') {
        return false
      }
      return true
    },

    showRegionLink(regionId) {
      if (this.featureAuEnergy) {
        return true
      }
      if (regionId === 'au' && this.currentView === 'energy') {
        return false
      }
      return true
    }
  }
}
</script>

<style lang="scss" scoped>
@import '~/assets/scss/variables.scss';

$menu-border-colour: #ccc;
$menu-border-colour-hover: #999;

.drawer-wrapper {
  position: fixed;
  top: 0;
  bottom: 0;
  left: -100%;
  transition: all 0.3s linear;

  .drawer {
    position: fixed;
    top: 0;
    bottom: 0;
    left: -100%;
    width: 300px;
    background-color: #eee;
    transition: all 0.2s ease-in-out;
  }

  .drawer-header {
    display: flex;
    justify-content: space-between;
  }

  .close-button {
    padding: 0.7rem 1.5rem;
    font-size: 1.5rem;
    color: $opennem-link-color;
  }

  &.open {
    left: 0;
    right: 0;
    background-color: rgba(0, 0, 0, 0.85);

    .drawer {
      left: 0;
    }
  }

  ::v-deep footer {
    display: flex;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    align-items: flex-end;

    .left,
    .right {
      display: block;
    }

    .right {
      text-align: right;
    }

    .about-link {
      display: block;
    }
  }
}

.header-logo {
  width: 2.3rem;
  max-height: 2.3rem;
  margin: 0.2rem $app-padding / 2;
  position: relative;
  top: 10px;
  left: 10px;
}

.menu {
  margin: 20px 0;

  .menu-item {
    display: block;
    padding: 4px 20px;
    color: #000;
    border-bottom: 1px solid #dedede;

    &.has-divider {
      border-bottom-color: #aaa;
    }

    &:hover {
      background: #dedede;
    }

    &.nuxt-link-active {
      font-weight: 600;
      border-right: 6px solid $opennem-link-color;
      color: $opennem-link-color;

      .icon {
        display: none;
      }
    }

    .icon {
      position: absolute;
      right: 15px;
      color: rgba(100, 100, 100, 0.5);
    }
  }

  .menu-item-child {
    padding-left: 2.5rem;
    position: relative;

    &::before {
      content: '';
      border-left: 1px dashed $menu-border-colour;
      position: absolute;
      top: 1px;
      bottom: 0;
      left: 1.5rem;
    }
    &::after {
      content: '';
      border-bottom: 1px dashed $menu-border-colour;
      position: absolute;
      width: 7px;
      top: 0;
      bottom: 14px;
      left: 1.5rem;
    }

    &.nuxt-link-active::after {
      border-color: $opennem-link-color;
    }

    &:hover::before,
    &:hover::after {
      border-color: $menu-border-colour-hover;
    }

    &.menu-item-first-child::before {
      top: 0px;
    }

    &.menu-item-last-child::before {
      bottom: 14px;
    }
  }
}
.app-options {
  padding: 0.5rem 0.6rem;
  margin: 0.5rem;
  background-color: rgba(0, 0, 0, 0.05);
  border-radius: 4px;

  .control {
    display: flex;
    justify-content: space-between;
    align-items: center;

    label {
      font-size: 0.8em;
      font-family: $family-secondary;
      font-weight: bold;
      color: #333;
    }
  }
}
</style>
